language: python
python:
  - 3.7
os: linux
dist: xenial
cache: pip
services:
  - docker
env:
  global:
    - DOCKER_COMPOSE_VERSION=1.26.2
    - DEPENDENCIES=jackgreenberg/tools-dependencies
    - BACKEND=jackgreenberg/tools-backend
    - secure: znfGbnNjQhqc309T9mBfrLYvXPgPkydW6f0zH03e83nQKtIbs56vX1gpOlbXtgVQRewRF7HBUlWBEilC1TQVu0dxmT45KP+aBdoiCOHq+c4Z+nOqq+UPql0HgF3vOgmxQA8ilbU5TAUt+2D80deFCTVdPOuhs6GtKFKUzmjZGMMbr12z9tU6DhSsumD4keplmGCMaLEpz9IzCcA1KIJ/pkvpK/rO0aT4BvKTDOLbz/QkdCfsTFFStqr6Ztt1hHszOOtwhRIFQa/C5xGmqDSP/vn9Vl2PEAV8+zdh3BHpbo0ci+Vp/OZdsPXC27x2wm248j9wLM5mnAXlsqFpyC34Xf/xCBo+cPoIq8KCxalX6C1zImiDhTO4266+xnOFXCzEhKsV9IEcdE71nroXP9zmmm/RiAyGKkwn/Ppas2R9MF3hPp6af8iSMcRQ/X11xD9iigtTG1+y8b+BFGC2E+VnRZMMdg/OZuBHUweuCAwNpOrBIdnfekaczO/65bLi6nAqSZMwEiipVekYWF9Zid2tNaHJXYUrUb8VwHWfQiwPyoyrCDuVKVuR6t30B85uEV+bUqTAO/IH+5BtARZOo52a+6Bbi2k+V4+kBnkltlz9xpGsUon3dLYYDUWp5ksSS1e/o3QW9fbUQ/xO1Z88ElByyQA0A6rDbDlrJo57TRVYAfc=
    - secure: R82v5oXa6BrannvUWyoQhdyFgn/FnrNpbroTREbFK2I1vXyxqwM1scbSXctXYwsCfIIselWfoLrXqsMna0kWA0VC4PjXzKbm6x2HfOwU9nMWNBajtMbFIhE8yWp6YpxQBx5GRRHGaGBfWnyVVZ7dWza7UtozWzg6sm81PjnA1R9Y1ZF+Mk5otHvKHEnEe1goG4kP7NQTXppMkKHtbWOcjQfF5v4DzQicl+f6YBoqE1Sa9KbOZfS9+Af1Yud1uuOza5xY1AWnxuKYjvIkIRnq7G2/K/SMJOHMh1p2u8s8n3XfwZkYKacRoPaeLLVWtUuKLJz2ImoJ2t2ik5NGTSMk2KWpc7xx/fEK1sPrK/K/AFZoQfSsT1i4WbMWY5H4VgdCghwz0LqvqIC7smAfVscBQsJJAbNxmHzpszJLwbybq02vmJ+S62TnbBJMCflsNcxr2G+IuUEbNrpHp+HyaTfnBpYS03WFFxgd5PJ1PhSQpJh+tlKUd4sSYrUvThPEddImtQQVCp3xhQBCNG5IiDF1evFwaeIkKczHkBwCC7tCZBGwZVMoNqTgzzr15l63l2jqgql7xtXe+sLtFIMSuGT8nlLysco+dlyDB6VkMphdKYUpzzmQ/FyarEs5dRfK6NvW7wUM9b4TTNJUg+llusTIB3487fUknUDqM1ePOVzdkG8=

# Install docker-compose version
before_install:
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - docker-compose --version

# Build docker containers
install:
  - docker pull ${DEPENDENCIES} || true
  - docker build --pull -t ${DEPENDENCIES} --cache-from ${DEPENDENCIES} --target=dependencies .
  - docker build --tag ${BACKEND} --cache-from ${DEPENDENCIES} --cache-from ${BACKEND} .

# Run the containers with docker-compose
before_script:
  - docker-compose up -d
  - docker-compose ps

# Run tests and lints
script:
  - docker exec -ti -e CODECOV_TOKEN=${CODECOV_TOKEN} tools-backend nox -s lint safety tests coverage

# Spin down docker containers
after_script:
  - docker-compose down

after_success:
  - echo "$DOCKER_PASS" | docker login -u jackgreenberg --password-stdin
  - docker push $DEPENDENCIES:latest

notifications:
  webhooks:
    - https://fathomless-fjord-24024.herokuapp.com/notify
